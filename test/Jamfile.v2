
import feature ;
import generators ;
import modules ;
import project ;
import targets ;
import testing ;
import toolset ;
import type ;

path-constant local-boost-root : [ get_boost_root ] ;

#exe line-compare-tool : src/text_diff.cpp ;

alias auto_index : ../build//auto_index : release ;
alias line_compare_tool : $(local-boost-root)/tools/quickbook/test//line-compare-tool ;

rule auto-index-test ( target-name : input-file : output-file ? : options * )
{
    local project = [ project.current ] ;

    local t =
        [ targets.create-typed-target RUN
            : $(project)
            : $(target-name)
            : .//auto_index
            : $(requirements)
                <location-prefix>$(target-name).test
                <testing.arg>prefix=$(local-boost-root)
                <testing.arg>$(options)
                <testing.arg>in=$(input-file)
                <testing.arg>out=$(target-name).out
                <preserve-test-targets>on
                <dependency>Jamfile.v2
                <dependency>$(input-file)
        ]
        ;
    
    t += 
        [ targets.create-typed-target RUN
            : $(project)
            : $(target-name)_check
            : .//line_compare_tool
            : $(requirements)
                <location-prefix>$(target-name).test
                <testing.arg>$(target-name).out
                <testing.arg>$(target-name).gold
                <preserve-test-targets>on
                <dependency>$(target_name)
                <implicit-dependency>$(target_name)
                <dependency>Jamfile.v2
                <dependency>$(input-file)
        ]
        ;

    modules.poke testing : .all-tests : \$\(all-tests\) $(t) ;

    return $(t) ;
}

auto-index-test test1 : type_traits.docbook : : script=index.idx ;
auto-index-test test2 : type_traits.docbook : : --internal-index script=index.idx ;
auto-index-test test3 : type_traits.docbook : : --internal-index index-type=appendix script=index.idx ;


